"use strict";(()=>{var e={};e.id=692,e.ids=[692],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},7290:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>m,POST:()=>y,dynamic:()=>d,runtime:()=>l});var n=r(49303),a=r(88716),o=r(60670),i=r(87070),u=r(75571),c=r(95456),p=r(42281);let l="nodejs",d="force-dynamic";async function m(e){if(!(0,c.II)())return i.NextResponse.json([],{status:200});let t=await (0,u.getServerSession)(c.Lz),r=t?.groups;if(!t||!(0,c.YO)(r))return i.NextResponse.json({error:"Forbidden"},{status:403});let{searchParams:s}=new URL(e.url),n=s.get("search")||void 0,a=parseInt(s.get("page")||"0",10),o=parseInt(s.get("pageSize")||"20",10),l=Math.max(0,a)*Math.max(1,o),d=await (0,p.rz)(n,l,o),m=await (0,p.Xn)(n);return i.NextResponse.json({users:d,total:m,page:a,pageSize:o})}async function y(e){if(!(0,c.II)())return i.NextResponse.json({error:"Auth disabled"},{status:501});let t=await (0,u.getServerSession)(c.Lz),r=t?.groups;if(!t||!(0,c.YO)(r))return i.NextResponse.json({error:"Forbidden"},{status:403});let s=await e.json(),n=String(s?.username||"").trim(),a=s?.email?String(s.email):void 0,o=String(s?.password||"").trim(),l=Array.isArray(s?.groups)?s.groups:[];if(!n||!o)return i.NextResponse.json({error:"Missing username/password"},{status:400});let d=[];l.length&&(d=(await (0,p.eZ)()).filter(e=>l.includes(e.name)).map(e=>e.id));let m=await (0,p.tz)({username:n,email:a,password:o,groups:d});return i.NextResponse.json({id:m})}let f=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/identity/users/route",pathname:"/api/admin/identity/users",filename:"route",bundlePath:"app/api/admin/identity/users/route"},resolvedPagePath:"C:\\Users\\fabia\\Documents\\Personal\\Trabajo\\git_Projects\\test-codex2\\src\\app\\api\\admin\\identity\\users\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:w}=f,$="/api/admin/identity/users/route";function x(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},95456:(e,t,r)=>{r.d(t,{II:()=>u,Lz:()=>c,YO:()=>l});var s=r(75571),n=r.n(s),a=r(71689),o=r(70591);function i(){let{KEYCLOAK_ISSUER:e,KEYCLOAK_CLIENT_ID:t,KEYCLOAK_CLIENT_SECRET:r}=process.env;return e&&t&&r?[(0,a.Z)({clientId:t,clientSecret:r,issuer:e})]:[]}let u=()=>i().length>0,c={providers:i(),session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET,callbacks:{async jwt({token:e,account:t}){if(t&&t.id_token)try{let r=(0,o.o)(t.id_token),s=r.groups||r.realm_access?.roles||[];Array.isArray(s)&&(e.groups=s)}catch{}else if(t&&t.access_token)try{let r=(0,o.o)(t.access_token),s=r.groups||r.realm_access?.roles||[];Array.isArray(s)&&(e.groups=s)}catch{}return e},session:async({session:e,token:t})=>(e.sub=t.sub,e.groups=t.groups||[],e)}},{handlers:p}=n()(c);function l(e){let t=(process.env.ADMIN_GROUP||process.env.NEXT_PUBLIC_ADMIN_GROUP||"devops").toLowerCase();return!!e?.some(e=>String(e).toLowerCase()===t)}},42281:(e,t,r)=>{function s(){let e=(process.env.KEYCLOAK_ISSUER||"").match(/^(https?:\/\/[^/]+)\/realms\/([^/]+)/i);if(!e)throw Error("KEYCLOAK_ISSUER inv\xe1lido");return{base:e[1],realm:e[2]}}r.d(t,{Ky:()=>y,Pm:()=>m,Qq:()=>p,SQ:()=>$,Tk:()=>u,Xn:()=>w,an:()=>f,eZ:()=>i,lV:()=>c,ou:()=>g,rz:()=>l,tz:()=>d,zM:()=>h});let n=null;async function a(){let e=Math.floor(Date.now()/1e3);if(n&&n.exp-30>e)return n.token;let{base:t}=s(),r=process.env.KEYCLOAK_ADMIN_USER||process.env.KEYCLOAK_ADMIN||"admin",a=process.env.KEYCLOAK_ADMIN_PASSWORD||"admin",o=`${t}/realms/master/protocol/openid-connect/token`,i=new URLSearchParams({grant_type:"password",client_id:"admin-cli",username:r,password:a}),u=await fetch(o,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:i});if(!u.ok)throw Error(`Keycloak token error: ${u.status}`);let c=await u.json();return(n={token:c.access_token,exp:Math.floor(Date.now()/1e3)+(c.expires_in||60)}).token}async function o(e,t,r){let{base:n}=s(),o=await a(),i=await fetch(`${n}${t}`,{method:e,headers:{Authorization:`Bearer ${o}`,...r?{"content-type":"application/json"}:{}},body:r?JSON.stringify(r):void 0});if(204!==i.status){if(!i.ok)throw Error(`Keycloak error ${i.status}`);if((i.headers.get("content-type")||"").includes("application/json"))return await i.json()}}async function i(){let{realm:e}=s();return o("GET",`/admin/realms/${e}/groups`)}async function u(e){let{realm:t}=s(),{base:r}=s(),n=await a(),o=await fetch(`${r}/admin/realms/${t}/groups`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"content-type":"application/json"},body:JSON.stringify({name:e})});if(!o.ok)throw Error(`Keycloak create group ${o.status}`);let i=(o.headers.get("location")||"").match(/\/groups\/([^/]+)$/);return i?i[1]:void 0}async function c(e,t){let{realm:r}=s();await o("PUT",`/admin/realms/${r}/groups/${e}`,{name:t})}async function p(e){let{realm:t}=s();await o("DELETE",`/admin/realms/${t}/groups/${e}`)}async function l(e,t,r){let{realm:n}=s(),a=new URLSearchParams;e&&a.set("search",e),"number"==typeof t&&a.set("first",String(t)),"number"==typeof r&&a.set("max",String(r));let i=a.toString(),u=i?`?${i}`:"";return o("GET",`/admin/realms/${n}/users${u}`)}async function d(e){let{username:t,email:r,password:n,groups:o}=e,{realm:i}=s(),{base:u}=s(),c=await a(),p=await fetch(`${u}/admin/realms/${i}/users`,{method:"POST",headers:{Authorization:`Bearer ${c}`,"content-type":"application/json"},body:JSON.stringify({username:t,email:r,enabled:!0})});if(!p.ok)throw Error(`Keycloak create user ${p.status}`);let l=(p.headers.get("location")||"").match(/\/users\/([^/]+)$/),d=l?l[1]:"";if(!d)throw Error("No se pudo obtener ID de usuario");if(n&&await fetch(`${u}/admin/realms/${i}/users/${d}/reset-password`,{method:"PUT",headers:{Authorization:`Bearer ${c}`,"content-type":"application/json"},body:JSON.stringify({type:"password",value:n,temporary:!1})}),o&&o.length)for(let e of o)await fetch(`${u}/admin/realms/${i}/users/${d}/groups/${e}`,{method:"PUT",headers:{Authorization:`Bearer ${c}`}});return d}async function m(e){let{realm:t}=s();await o("DELETE",`/admin/realms/${t}/users/${e}`)}async function y(e,t,r=!1){let{realm:n}=s(),{base:o}=s(),i=await a();await fetch(`${o}/admin/realms/${n}/users/${e}/reset-password`,{method:"PUT",headers:{Authorization:`Bearer ${i}`,"content-type":"application/json"},body:JSON.stringify({type:"password",value:t,temporary:r})})}async function f(e){let{realm:t}=s();return o("GET",`/admin/realms/${t}/users/${e}/groups`)}async function g(e,t){let{realm:r}=s();await o("PUT",`/admin/realms/${r}/users/${e}/groups/${t}`)}async function h(e,t){let{realm:r}=s();await o("DELETE",`/admin/realms/${r}/users/${e}/groups/${t}`)}async function w(e){let{realm:t}=s(),r=e?`?search=${encodeURIComponent(e)}`:"",n=await o("GET",`/admin/realms/${t}/users/count${r}`);return"number"==typeof n?n:n?.count??0}async function $(e,t,r){let{realm:n}=s(),a=new URLSearchParams;"number"==typeof t&&a.set("first",String(t)),"number"==typeof r&&a.set("max",String(r));let i=a.toString()?`?${a.toString()}`:"";return o("GET",`/admin/realms/${n}/groups/${e}/members${i}`)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972,16],()=>r(7290));module.exports=s})();